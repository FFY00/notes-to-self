<!DOCTYPE HTML>

<html lang="en-us">

<head>
	<meta charset="utf-8">
	<title>Testing Ansible roles with Travis-CI, Part 1: CentOS - Notes to self</title>
	<meta name="author" content="map[email:bert.vanvreckem@gmail.com name:Bert Van Vreckem]">

	
	
	<meta name="description" content="">
	

	
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    
	<link href='https://bertvv.github.io/notes-to-self/index.xml' rel="alternate" title="Notes to self" type="application/atom+xml">
	
	<link rel="canonical" href="https://bertvv.github.io/notes-to-self/2015/12/11/testing-ansible-roles-with-travis-ci-part-1-centos">
	<link href="https://bertvv.github.io/notes-to-self/favicon.png" rel="shortcut icon">
	<link href="https://bertvv.github.io/notes-to-self/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="https://bertvv.github.io/notes-to-self/css/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	
	<link href="https://fonts.googleapis.com/css?family=Nunito:400,300,700" rel="stylesheet" type="text/css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	
	<script src="https://bertvv.github.io/notes-to-self/js/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='https://www.gravatar.com/avatar/" + MD5('bert.vanvreckem@gmail.com') + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="https://bertvv.github.io/notes-to-self/">Blog</a></li>
    <li><a href="https://bertvv.github.io/notes-to-self/about/">About</a></li>
    <li><a href="https://bertvv.github.io/notes-to-self/post/">Archives</a></li>
</ul>


<section class="aboutme">
  <p>
    Linux system administration, config management, and stuff
  </p>
</section>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href='mailto:bert.vanvreckem@gmail.com' title="Email">Email</a>
		
		
		
		
			<a class="twitter" href='https://twitter.com/bertvanvreckem' title="Twitter">Twitter</a>
		
		
			<a class="github" href='https://github.com/bertvv' title="GitHub">GitHub</a>
		
		
		
		
			<a class="linkedin" href='https://www.linkedin.com/in/bertvanvreckem' title="LinkedIn">LinkedIn</a>
		
		
			<a class="youtube" href='https://youtube.com/bertvvrhogent' title="Youtube">Youtube</a>
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href='https://bertvv.github.io/notes-to-self/index.xml' title="RSS">RSS</a>
		
	</div>
</nav>
</header>
			</div>
		</div>
		<div class="mid-col">
			
			<div class="mid-col-container">
				<div id="content" class="inner">
					<div itemscope itemtype="https://schema.org/Blog">
					<article class="post" itemscope itemtype="https://schema.org/BlogPosting">
    <h1 class="title" itemprop="name">Testing Ansible roles with Travis-CI, Part 1: CentOS</h1>
	<div class="entry-content" itemprop="articleBody"><p>In this first post on testing Ansible roles with Travis-CI, we&rsquo;ll discuss how you can apply a test playbook on CentOS. Out-of-the-box, Travis-CI doesn&rsquo;t support CentOS, as its test environment is Ubuntu-based. However, Travis-CI allows you to set up a Docker container and this opens up all kinds of possibilities.</p>

<p></p>

<p>I&rsquo;ve known about <a href="https://travis-ci.org/">Travis-CI</a> as a test platform for a while now, but haven&rsquo;t tried it out until a few days ago. It is mainly used for running tests on applications, but it has seen use for infrastructure testing as well. For example, Jeff Geerling already <a href="https://servercheck.in/blog/testing-ansible-roles-travis-ci-github">wrote about testing Ansible roles</a> using Travis-CI.</p>

<p>There&rsquo;s a lot to like about Travis-CI: it&rsquo;s free for open source projects and it integrates nicely with Github so that on every push and submitted pull request a test run is triggered. During a test run, a VM is booted and a script called <code>.travis.yml</code> is executed. This contains the necessary steps to configure the system, install dependencies and run the actual test code. Jeff Geerling&rsquo;s method of testing Ansible roles consists of installing Ansible and then running a test playbook locally that applies the role to the VM.</p>

<p>Now, the reason that I haven&rsquo;t been working with Travis-CI before (apart from lack of time), is that the VM that&rsquo;s being created is Ubuntu-based. I&rsquo;m mostly working with CentOS, however, and all <a href="https://galaxy.ansible.com/detail#/user/8834">my Ansible roles</a> only run on CentOS (at least for now). So as far as I knew, Travis-CI was not suitable for my needs.</p>

<p>Earlier this week, I ran into a <a href="https://stackoverflow.com/questions/29453017/build-project-on-centos-using-travis">question on StackOverflow</a> on this very subject. One of the replies stated that it is possible to run CentOS on Travis-CI using Docker. Interesting&hellip;</p>

<p>Docker is another technology I haven&rsquo;d played with before, so two learning opportunities in one go! I&rsquo;m not going to delve into getting started with Docker, <a href="https://docs.docker.com/engine/userguide/basics/">you can find that elsewhere</a>.</p>

<h2 id="setting-up-a-centos-docker-container">Setting up a CentOS Docker container</h2>

<p>In this section, we&rsquo;re going to set up a simple test for my own <a href="https://galaxy.ansible.com/detail#/role/3047">Apache role</a>.
The first step is to create a Docker container for CentOS with all dependencies installed. After a few attempts, I settled for the following Dockerfile:</p>

<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>FROM centos:7
<span style="color: #0099FF; font-style: italic"># Install systemd -- See https://hub.docker.com/_/centos/</span>
RUN yum -y swap -- remove fakesystemd -- install systemd systemd-libs
RUN yum -y update; yum clean all; <span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #555555">(</span><span style="color: #336666">cd</span> /lib/systemd/system/sysinit.target.wants/; <span style="color: #006699; font-weight: bold">for</span> i in *; <span style="color: #006699; font-weight: bold">do</span> <span style="color: #555555">[</span> <span style="color: #003333">$i</span> <span style="color: #555555">==</span> systemd-tmpfiles-setup.service <span style="color: #555555">]</span> <span style="color: #555555">||</span> rm -f <span style="color: #003333">$i</span>; <span style="color: #006699; font-weight: bold">done</span><span style="color: #555555">)</span>; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/multi-user.target.wants/*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /etc/systemd/system/*.wants/*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/local-fs.target.wants/*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/sockets.target.wants/*udev*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/sockets.target.wants/*initctl*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/basic.target.wants/*; <span style="color: #CC3300; font-weight: bold">\</span>
rm -f /lib/systemd/system/anaconda.target.wants/*;
<span style="color: #0099FF; font-style: italic"># Install Ansible</span>
RUN yum -y install epel-release
RUN yum -y install git ansible sudo
RUN yum clean all
<span style="color: #0099FF; font-style: italic"># Disable requiretty</span>
RUN sed -i -e <span style="color: #CC3300">&#39;s/^\(Defaults\s*requiretty\)/#--- \1/&#39;</span>  /etc/sudoers
<span style="color: #0099FF; font-style: italic"># Install Ansible inventory file</span>
RUN <span style="color: #336666">echo</span> -e <span style="color: #CC3300">&#39;[local]\nlocalhost ansible_connection=local&#39;</span> &gt; /etc/ansible/hosts
VOLUME <span style="color: #555555">[</span> <span style="color: #CC3300">&quot;/sys/fs/cgroup&quot;</span> <span style="color: #555555">]</span>
CMD <span style="color: #555555">[</span><span style="color: #CC3300">&quot;/usr/sbin/init&quot;</span><span style="color: #555555">]</span>
</pre></div>


<p>This is based a.o. on the <a href="https://hub.docker.com/_/centos/">guidelines</a> for the <code>centos:7</code> image found on Docker Hub. By default, systemd is not available inside the container, so the code above installs it, albeit in a limited form. After that, Ansible is installed and a basic inventory file is generated.</p>

<h2 id="running-the-ansible-test-on-travis-ci">Running the Ansible test on Travis-CI</h2>

<p>The next step is to configure Travis-CI with a <code>.travis.yml</code> file. In this stage, I ran into another problem w.r.t. systemd. After building the container, I succeeded in running <code>ansible-playbook</code>, but the role failed when the service was started:</p>

<pre><code>[...A number of succeeding tasks, a.o. installation of httpd...]

TASK: [bertvv.httpd | Ensure Apache is always running] ************************
failed: [localhost] =&gt; {&quot;failed&quot;: true}
msg: no service or tool found for: httpd
</code></pre>

<p>Theres&rsquo;s a <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1033604">bug report</a> relating to this issue. Dan Walsh <a href="https://developerblog.redhat.com/2014/05/05/running-systemd-within-docker-container/">navigates around this problem</a> by enabling the service after installation and then running a new container that will start the service at boot time. For our purposes, this is not a feasible solution. Another caveat is that the container should run in privileged mode in order to make systemd work.</p>

<p>Finally, I got to the following <code>.travis.yml</code> file:</p>

<div class="highlight" style="background: #f0f3f3"><pre style="line-height: 125%"><span></span>sudo: required

services:
  - docker

before_install:
  <span style="color: #0099FF; font-style: italic"># Fetch base image and build new container</span>
  - sudo docker pull centos:7
  - sudo docker build --rm=true --tag=travispoc .

script:
  <span style="color: #0099FF; font-style: italic"># Run container in detached state</span>
  - sudo docker run --detach --privileged --volume=&quot;${PWD}&quot;:/etc/ansible/roles/role_under_test:ro --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro travispoc /usr/lib/systemd/systemd &gt; /tmp/container_id
  <span style="color: #0099FF; font-style: italic"># Check syntax of ansible playbook</span>
  - sudo docker exec &quot;$(cat /tmp/container_id)&quot; ansible-playbook /etc/ansible/roles/role_under_test/test.yml --syntax-check
  <span style="color: #0099FF; font-style: italic"># Run ansible playbook</span>
  - sudo docker exec &quot;$(cat /tmp/container_id)&quot; ansible-playbook /etc/ansible/roles/role_under_test/test.yml
  <span style="color: #0099FF; font-style: italic"># Clean up</span>
  - sudo docker stop &quot;$(cat /tmp/container_id)&quot;

notifications:
  email: false
</pre></div>


<p>See the result of the build process on the <a href="https://travis-ci.org/bertvv/travispoc/builds/96155750">Travis-CI status page</a>. This configuration pulls down the base image <code>centos:7</code> and builds the custom container with Ansible installed. The custom container is then run in privileged mode and detached. The current directory (= the project root of the Git project) is mounted inside the container under <code>/etc/ansible/roles/role_under_test/</code>. The name of the directory is not important, actually, and giving it a generic one makes the code reusable over any role. The <code>docker run</code> command yields an ID that is written to a temporary file. After that, the test playbook (see below) is executed, once with the <code>--syntax-check</code> option, and once without (actually applying the role to the container).</p>

<pre><code class="language-Yaml"># test.yml
---
- hosts: all
  roles:
    - role_under_test
</code></pre>

<p>The playbook is kept minimal here, but a <code>vars:</code> section can be added to set role variables. The role is called <code>role_under_test</code>, consistent with the directory mentioned above.</p>

<h2 id="limitations">Limitations</h2>

<p>In the end, a container is -intentionally- not a full VM, so it does have its limitations. As discussed before, systemd is not available out-of-the-box. Basic services that you expect to be present, like ssh and firewalld aren&rsquo;t installed by default. Another big issue is SELinux. Since this is a kernel extension, I suspect it would interact with the host system. The host system in this case is Travis-CI&rsquo;s Ubuntu box that runs the tests, and that certainly won&rsquo;t have SELinux enabled. I haven&rsquo;t looked into this, but I suspect that in this setting, SELinux will not work inside the container. Please let me know in the comments if I&rsquo;m wrong! Anyway, my roles usually assume SELinux is running, so I suspect it won&rsquo;t be possible to test these on Travis-CI&hellip; In those cases, a solution based on full virtualization like KVM, VirtualBox, etc. is probably more suitable.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In this post, I discussed a proof of concept for testing Ansible roles on CentOS using Travis-CI. The code can be found on <a href="https://github.com/bertvv/travispoc">https://github.com/bertvv/travispoc</a> and is tagged <code>centos</code> (See the <a href="https://github.com/bertvv/travispoc/tags">tags page</a>). Although there are some limitations (SELinux being a notable one), Travis-CI is usable as a testing platform in this setting.</p>

<p>There&rsquo;s probably for improvement. I probably did things in a suboptimal way, because I&rsquo;m still new to both Travis-CI and Docker, so suggestions are welcome! You can leave a comment below, create an issue on the Github project or send me a pull request.</p>

<p>In a next blog post, we&rsquo;ll extend this solution for running tests on multiple platforms.</p>

<p><strong>Edit:</strong> There was a major flaw in the code of the original version of this post. It installed the role under test from Ansible Galaxy instead of running on the <em>current</em> commit. The <code>Dockerfile</code> and <code>.travis.yml</code> were adapted to fix this.</p></div></article>
					
						<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size=''></a>
	
	
	</div>
	
  	<script type="text/javascript" src='https://s7.addthis.com/js/250/addthis_widget.js#pubid='></script>
  	
</div>

					
					
					<section id="comment">
					    <h1 class="title">Comments</h1>
					    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
					</section>
					
					<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'notes-to-self-bertvv';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

				    </div>
				</div>
			</div>
			<footer id="footer" class="inner">
    © 2015 Bert Van Vreckem. Creative Commons Attribution 4.0. Please attribute properly and link back.


Design credit: <a href="https://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a>
<script src="https://bertvv.github.io/notes-to-self/js/slash.js"></script>
<script src="https://bertvv.github.io/notes-to-self/js/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
</footer>
		</div>
	</div>
	
</body>
</html>

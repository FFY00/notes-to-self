<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Docker on Notes to self </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>http://localhost:1313/notes-to-self/tags/docker/</link>
    <language>en-us</language>
    <author>Bert Van Vreckem</author>
    <copyright>Â© 2015 Bert Van Vreckem. Creative Commons Attribution 4.0. Please attribute properly and link back.</copyright>
    <updated>Fri, 11 Dec 2015 20:49:16 CET</updated>
    
    <item>
      <title>Testing Ansible roles with Travis-CI, Part 1: CentOS</title>
      <link>http://localhost:1313/notes-to-self/2015/12/11/testing-ansible-roles-with-travis-ci-part-1-centos</link>
      <pubDate>Fri, 11 Dec 2015 20:49:16 CET</pubDate>
      <author>Bert Van Vreckem</author>
      <guid>http://localhost:1313/notes-to-self/2015/12/11/testing-ansible-roles-with-travis-ci-part-1-centos</guid>
      <description>

&lt;p&gt;In this first post on testing Ansible roles with Travis-CI, we&amp;rsquo;ll discuss how you can apply a test playbook on CentOS.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve known about &lt;a href=&#34;https://travis-ci.org/&#34;&gt;Travis-CI&lt;/a&gt; as a test platform for a while now, but haven&amp;rsquo;t tried it out until a few days ago. It is mainly used for running tests on applications, but it has seen use for infrastructure testing as well. For example, Jeff Geerling already &lt;a href=&#34;https://servercheck.in/blog/testing-ansible-roles-travis-ci-github&#34;&gt;wrote about testing Ansible roles&lt;/a&gt; using Travis-CI.&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s a lot to like about Travis-CI: it&amp;rsquo;s free for open source projects and it integrates nicely with Github so that on every push and submitted pull request a test run is triggered. During a test run, a VM is booted and a script called &lt;code&gt;.travis.yml&lt;/code&gt; is executed. This contains the necessary steps to configure the system, install dependencies and run the actual test code. Jeff Geerling&amp;rsquo;s method of testing Ansible roles consists of installing Ansible and then running a test playbook locally that applies the role to the VM.&lt;/p&gt;

&lt;p&gt;Now, the reason that I haven&amp;rsquo;t been working with Travis-CI before (apart from lack of time), is that the VM that&amp;rsquo;s being created is Ubuntu-based. I&amp;rsquo;m mostly working with CentOS, however, and all &lt;a href=&#34;https://galaxy.ansible.com/detail#/user/8834&#34;&gt;my Ansible roles&lt;/a&gt; only run on CentOS (at least for now). So as far as I knew, Travis-CI was not suitable for my needs.&lt;/p&gt;

&lt;p&gt;Earlier this week, I ran into a &lt;a href=&#34;https://stackoverflow.com/questions/29453017/build-project-on-centos-using-travis&#34;&gt;question on StackOverflow&lt;/a&gt; on this very subject. One of the replies stated that it is possible to run CentOS on Travis-CI using Docker. Interesting&amp;hellip;&lt;/p&gt;

&lt;p&gt;Docker is another technology I haven&amp;rsquo;d played with before, so two learning opportunities in one go! I&amp;rsquo;m not going to delve into getting started with Docker, &lt;a href=&#34;https://docs.docker.com/engine/userguide/basics/&#34;&gt;you can find that elsewhere&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;setting-up-a-centos-docker-container:48d64d145fbcb082238fb5b7d00b35e8&#34;&gt;Setting up a CentOS Docker container&lt;/h2&gt;

&lt;p&gt;In this section, we&amp;rsquo;re going to set up a simple test for my own &lt;a href=&#34;https://galaxy.ansible.com/detail#/role/3047&#34;&gt;Apache role&lt;/a&gt;.
The first step is to create a Docker container for CentOS with all dependencies installed. After a few attempts, I settled for the following Dockerfile:&lt;/p&gt;

&lt;p&gt;&lt;div class=&#34;highlight&#34; style=&#34;background: #f0f3f3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;FROM centos:7
&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Install systemd -- See https://hub.docker.com/_/centos/&lt;/span&gt;
RUN yum -y swap -- remove fakesystemd -- install systemd systemd-libs
RUN yum -y update; yum clean all; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
&lt;span style=&#34;color: #555555&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #336666&#34;&gt;cd&lt;/span&gt; /lib/systemd/system/sysinit.target.wants/; &lt;span style=&#34;color: #006699; font-weight: bold&#34;&gt;for&lt;/span&gt; i in *; &lt;span style=&#34;color: #006699; font-weight: bold&#34;&gt;do&lt;/span&gt; &lt;span style=&#34;color: #555555&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #003333&#34;&gt;$i&lt;/span&gt; &lt;span style=&#34;color: #555555&#34;&gt;==&lt;/span&gt; systemd-tmpfiles-setup.service &lt;span style=&#34;color: #555555&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #555555&#34;&gt;||&lt;/span&gt; rm -f &lt;span style=&#34;color: #003333&#34;&gt;$i&lt;/span&gt;; &lt;span style=&#34;color: #006699; font-weight: bold&#34;&gt;done&lt;/span&gt;&lt;span style=&#34;color: #555555&#34;&gt;)&lt;/span&gt;; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/multi-user.target.wants/*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /etc/systemd/system/*.wants/*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/local-fs.target.wants/*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/sockets.target.wants/*udev*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/sockets.target.wants/*initctl*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/basic.target.wants/*; &lt;span style=&#34;color: #CC3300; font-weight: bold&#34;&gt;\&lt;/span&gt;
rm -f /lib/systemd/system/anaconda.target.wants/*;
&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Install Ansible&lt;/span&gt;
RUN yum -y install epel-release
RUN yum -y install git ansible sudo
RUN yum clean all
&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Disable requiretty&lt;/span&gt;
RUN sed -i -e &lt;span style=&#34;color: #CC3300&#34;&gt;&amp;#39;s/^\(Defaults\s*requiretty\)/#--- \1/&amp;#39;&lt;/span&gt;  /etc/sudoers
&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Install Ansible inventory file&lt;/span&gt;
RUN &lt;span style=&#34;color: #336666&#34;&gt;echo&lt;/span&gt; -e &lt;span style=&#34;color: #CC3300&#34;&gt;&amp;#39;[local]\nlocalhost ansible_connection=local&amp;#39;&lt;/span&gt; &amp;gt; /etc/ansible/hosts
COPY requirements.yml /etc/ansible/requirements.yml
COPY test.yml /etc/ansible/test.yml
RUN ansible-galaxy install -r /etc/ansible/requirements.yml
VOLUME &lt;span style=&#34;color: #555555&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #CC3300&#34;&gt;&amp;quot;/sys/fs/cgroup&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #555555&#34;&gt;]&lt;/span&gt;
CMD &lt;span style=&#34;color: #555555&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #CC3300&#34;&gt;&amp;quot;/usr/sbin/init&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #555555&#34;&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;This is based a.o. on the &lt;a href=&#34;https://hub.docker.com/_/centos/&#34;&gt;guidelines&lt;/a&gt; for the &lt;code&gt;centos:7&lt;/code&gt; image found on Docker Hub. By default, systemd is not available inside the container, so the code above installs it, albeit in a limited form. After that, Ansible is installed and a basic inventory file is generated. Finally, the test code is pushed to the container, consisting of two files. The first one is &lt;code&gt;requirements.yml&lt;/code&gt; that &lt;a href=&#34;https://docs.ansible.com/ansible/galaxy.html#advanced-control-over-role-requirements-files&#34;&gt;specifies the dependencies&lt;/a&gt;, including the role under test. These are installed using &lt;code&gt;ansible-galaxy&lt;/code&gt;. The second one is the test playbook &lt;code&gt;test.yml&lt;/code&gt; that will apply the role under test to the container.&lt;/p&gt;

&lt;p&gt;&lt;div class=&#34;highlight&#34; style=&#34;background: #f0f3f3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# /etc/ansible/requirements.yml&lt;/span&gt;
&lt;span style=&#34;color: #00CCFF; font-weight: bold&#34;&gt;---&lt;/span&gt;
- src: bertvv.httpd

&lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# /etc/ansible/test.yml&lt;/span&gt;
&lt;span style=&#34;color: #00CCFF; font-weight: bold&#34;&gt;---&lt;/span&gt;
- hosts: all
  roles:
    - bertvv.httpd
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;h2 id=&#34;running-the-ansible-test-on-travis-ci:48d64d145fbcb082238fb5b7d00b35e8&#34;&gt;Running the Ansible test on Travis-CI&lt;/h2&gt;

&lt;p&gt;The next step is to configure Travis-CI with a &lt;code&gt;.travis.yml&lt;/code&gt; file. In this stage, I ran into another problem w.r.t. systemd. After building the container, I succeeded in running &lt;code&gt;ansible-playbook&lt;/code&gt;, but the role failed when the service was started:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[...A number of succeeding tasks, a.o. installation of httpd...]

TASK: [bertvv.httpd | Ensure Apache is always running] ************************
failed: [localhost] =&amp;gt; {&amp;quot;failed&amp;quot;: true}
msg: no service or tool found for: httpd
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Theres&amp;rsquo;s a &lt;a href=&#34;https://bugzilla.redhat.com/show_bug.cgi?id=1033604&#34;&gt;bug report&lt;/a&gt; relating to this issue. Dan Walsh &lt;a href=&#34;https://developerblog.redhat.com/2014/05/05/running-systemd-within-docker-container/&#34;&gt;navigates around this problem&lt;/a&gt; by enabling the service after installation and then running a new container that will start the service at boot time. For our purposes, this is not a feasible solution. Another caveat is that the container should run in privileged mode in order to make systemd work.&lt;/p&gt;

&lt;p&gt;Finally, I got to the following &lt;code&gt;.travis.yml&lt;/code&gt; file:&lt;/p&gt;

&lt;p&gt;&lt;div class=&#34;highlight&#34; style=&#34;background: #f0f3f3&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;sudo: required

services:
  - docker

before_install:
  &lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Fetch base image and build new container&lt;/span&gt;
  - sudo docker pull centos:7
  - sudo docker build --rm=true --tag=travispoc .

script:
  &lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Run container in detached state&lt;/span&gt;
  - sudo docker run --detach --privileged --volume=/sys/fs/cgroup:/sys/fs/cgroup:ro travispoc /usr/lib/systemd/systemd &amp;gt; /tmp/container_id
  &lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Check syntax of ansible playbook&lt;/span&gt;
  - sudo docker exec &amp;quot;$(cat /tmp/container_id)&amp;quot; ansible-playbook /etc/ansible/test.yml --syntax-check
  &lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Run ansible playbook&lt;/span&gt;
  - sudo docker exec &amp;quot;$(cat /tmp/container_id)&amp;quot; ansible-playbook /etc/ansible/test.yml
  &lt;span style=&#34;color: #0099FF; font-style: italic&#34;&gt;# Clean up&lt;/span&gt;
  - sudo docker stop &amp;quot;$(cat /tmp/container_id)&amp;quot;

notifications:
  email: false
&lt;/pre&gt;&lt;/div&gt;
&lt;/p&gt;

&lt;p&gt;See the result of the build process on the &lt;a href=&#34;https://travis-ci.org/bertvv/travispoc/builds/96155750&#34;&gt;Travis-CI status page&lt;/a&gt;. This configuration pulls down the base image &lt;code&gt;centos:7&lt;/code&gt; and builds the custom container with Ansible installed. The custom container is then run in privileged mode and detached. The command yields an ID that is written to a temporary file. After that, the test playbook is executed, once with the &lt;code&gt;--syntax-check&lt;/code&gt; option, and once without (actually applying the role to the container).&lt;/p&gt;

&lt;h2 id=&#34;limitations:48d64d145fbcb082238fb5b7d00b35e8&#34;&gt;Limitations&lt;/h2&gt;

&lt;p&gt;In the end, a container is -intentionally- not a full VM, so it does have its limitations. As discussed before, systemd is not available out-of-the-box. Basic services that you expect to be present, like ssh and firewalld aren&amp;rsquo;t installed by default. Another big issue is SELinux. Since this is a kernel extension, I suspect it would interact with the host system. The host system in this case is Travis-CI&amp;rsquo;s Ubuntu box that runs the tests, and that certainly won&amp;rsquo;t have SELinux enabled. I haven&amp;rsquo;t looked into this, but I suspect that in this setting, SELinux will not work inside the container. Please let me know in the comments if I&amp;rsquo;m wrong! Anyway, my roles usually assume SELinux is running, so I suspect it won&amp;rsquo;t be possible to test these on Travis-CI&amp;hellip; In those cases, a solution based on full virtualization like KVM, VirtualBox, etc. is probably more suitable.&lt;/p&gt;

&lt;h2 id=&#34;conclusion:48d64d145fbcb082238fb5b7d00b35e8&#34;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;In this post, I discussed a proof of concept for testing Ansible roles on CentOS using Travis-CI. The code can be found on &lt;a href=&#34;https://github.com/bertvv/travispoc&#34;&gt;https://github.com/bertvv/travispoc&lt;/a&gt; and is tagged &lt;code&gt;centos&lt;/code&gt; (See the &lt;a href=&#34;https://github.com/bertvv/travispoc/tags&#34;&gt;tags page&lt;/a&gt;). Although there are some limitations (SELinux being a notable one), Travis-CI is usable as a testing platform in this setting.&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s room for improvement, of course. It would be interesting to postpone pushing the test code to the container until after the build. This would allow us to always use the same base image with Ansible installed instead of rebuilding it at each test run. One approach could be to start the container with the folder containing the test code mounted inside using the &lt;code&gt;--volume&lt;/code&gt; option. I probably did things in a suboptimal way, because I&amp;rsquo;m still new to both Travis-CI and Docker, so other suggestions are also welcome! You can leave a comment below, create an issue on the Github project or send me a pull request.&lt;/p&gt;

&lt;p&gt;In a next blog post, we&amp;rsquo;ll extend this solution for running tests on multiple platforms.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
